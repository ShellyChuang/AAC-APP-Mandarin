<!doctype html>
<html lang="zh-TW">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>AAC v30 â€” æƒ…ç·’èˆ‡èº«é«”äº’å‹•æ¿ï¼ˆæš–è‰²ç‰ˆï¼‰</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#fdfaf6;      /* ç±³ç™½ */
    --accent:#d4b483;  /* æŸ”æ£• */
    --accent-2:#f8e8b5;/* äº®é»ƒé»ç¶´ */
    --muted:#7a6a55;
    --card:#ffffff;
    --shadow: 0 6px 18px rgba(17,15,12,0.06);
    --radius:20px;
    --btn-height:68px;
    --btn-gap:16px;
    --safe-bottom: env(safe-area-inset-bottom, 12px);
  }
  html,body{height:100%; margin:0; padding:0; font-family:'Noto Sans TC', system-ui, -apple-system; background:var(--bg); color:#2b2b2b; -webkit-font-smoothing:antialiased;}
  .app { display:flex; flex-direction:column; height:100vh; box-sizing:border-box; }
  main{flex:1; overflow:auto; padding-bottom: calc(var(--btn-height) + var(--safe-bottom) + 24px);}

  /* header area (space for potential title) */
  .header{padding:12px 18px;}
  .title{font-weight:700; font-size:20px; color:var(--muted);}

  /* container cards */
  .card{background:var(--card); margin:12px 16px; border-radius:var(--radius); box-shadow:var(--shadow); padding:14px;}
  .section-title{font-weight:700; color:#3d2f20; margin-bottom:8px; font-size:16px;}

  /* bottom nav */
  .bottom-nav{position:fixed; left:0; right:0; bottom:0; height:calc(var(--btn-height) + var(--safe-bottom)); padding-bottom:var(--safe-bottom); background:linear-gradient(180deg, rgba(255,255,255,0.6), rgba(255,255,255,0.9)); border-top:1px solid rgba(0,0,0,0.04); display:flex; gap:0; z-index:60; align-items:center; justify-content:space-around;}
  .nav-btn{flex:1; height:var(--btn-height); display:flex; align-items:center; justify-content:center; gap:8px; flex-direction:column; background:transparent; border:none; font-weight:600; color:#8a7a63; font-size:13px;}
  .nav-btn.active{color:var(--accent);}

  /* grid for quick buttons and builder */
  .grid-2{display:grid; grid-template-columns: repeat(2, 1fr); gap:var(--btn-gap);}
  .grid-1{display:grid; grid-template-columns: 1fr; gap:var(--btn-gap);}
  .word-btn{background:linear-gradient(180deg, #fff, #fff); border-radius:16px; padding:10px; display:flex; flex-direction:column; align-items:center; justify-content:center; min-height:86px; font-weight:700; box-shadow:0 6px 14px rgba(0,0,0,0.04); border:1px solid rgba(0,0,0,0.03); cursor:pointer; user-select:none;}
  .word-emoji{font-size:34px; margin-bottom:6px;}
  .word-label{font-size:18px; color:#3d2f20;}

  /* sentence display */
  .sentence-area{display:flex; gap:10px; flex-wrap:wrap; align-items:center; padding:12px; border-radius:12px; background:linear-gradient(180deg,#fff,#faf7f2); border:1px solid rgba(0,0,0,0.03);}
  .sentence-chip{background:var(--accent-2); padding:8px 12px; border-radius:12px; font-weight:700; color:#3b2e1f; box-shadow:0 2px 6px rgba(0,0,0,0.04);}

  /* settings */
  .select, .btn { font-size:16px; }

  /* modal */
  .modal{position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,0.36); z-index:90;}
  .modal-card{background:var(--card); padding:16px; border-radius:14px; width:92%; max-width:420px; box-shadow:var(--shadow);}

  /* emotion + body layout */
  .tabs{display:flex; gap:8px; padding:8px;}
  .tab{padding:8px 12px; border-radius:12px; background:transparent; border:1px solid rgba(0,0,0,0.03); font-weight:600; cursor:pointer;}
  .tab.active{background:var(--accent); color:#fff;}

  /* body svg wrapper */
  .body-wrap{display:flex; gap:12px; align-items:center; justify-content:center; padding:8px;}
  .body-svg{width:220px; max-width:60vw; height:auto; touch-action: manipulation; user-select:none;}
  .body-hotspot{fill:transparent; cursor:pointer; transition:fill .15s ease, transform .08s ease;}
  .hot-active{fill:rgba(212,180,131,0.16); transform:scale(1.02);}

  /* responsive: iPad landscape -> 2col layout */
  @media (min-width:900px){
    main { padding-left:20px; padding-right:20px; }
    .two-col{display:flex; gap:16px; align-items:flex-start;}
    .left-col{flex:0 0 320px;}
    .right-col{flex:1;}
    .grid-2{grid-template-columns:repeat(3,1fr);}
    .body-svg{width:300px;}
  }

  /* feedback animation */
  .flash{animation: flash 280ms ease-out;}
  @keyframes flash { 0% { box-shadow:0 0 0 6px rgba(248,232,181,0.45);} 100%{box-shadow: none;} }

  /* accessibility */
  .sr-only{position:absolute !important; height:1px; width:1px; overflow:hidden; clip:rect(1px,1px,1px,1px); white-space:nowrap;}
</style>
</head>
<body>
<div class="app" role="application" aria-label="è¼”åŠ©æºé€šæ‡‰ç”¨ AAC v30">
  <header class="header">
    <div class="title">AAC v30 â€” æº«å’Œç…§è­·ç‰ˆ</div>
  </header>

  <main id="main">
    <!-- responsive two-column for wide screens -->
    <div id="layout-root">

      <!-- Quick + Emotion + Builder will swap views. By default show Quick -->
      <section id="quick-section" class="card" aria-hidden="false">
        <div class="section-title">ä¸€éµæ±‚åŠ©</div>
        <p style="margin:0 0 10px 0; color:#6b5a46;">å¸¸ç”¨å¿«é€ŸæŒ‰éˆ•ï¼Œé»æ“Šå³æœ—è®€ / ç™¼å‡ºæç¤º</p>

        <div id="quick-grid" class="grid-2">
          <!-- Buttons injected by JS -->
        </div>
      </section>

      <section id="emotion-section" class="card" style="display:none;" aria-hidden="true">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <div class="section-title">æƒ…ç·’èˆ‡èº«é«”éƒ¨ä½</div>
          <div style="font-size:13px; color:#8a7a63;">é»æ“Šåœ–åƒæˆ–æŒ‰éˆ•ä»¥æœ—è®€</div>
        </div>

        <div class="tabs" style="margin-top:10px;">
          <button class="tab active" data-tab="emotion">æƒ…ç·’æ¿</button>
          <button class="tab" data-tab="body">èº«é«”åœ°åœ–</button>
        </div>

        <div id="emotion-panel" style="margin-top:10px;">
          <div id="emotion-grid" class="grid-2">
            <!-- emotion buttons injected -->
          </div>
        </div>

        <div id="body-panel" style="display:none; margin-top:12px;">
          <div class="body-wrap">
            <!-- SVG äººé«”ç¤ºæ„ -->
            <svg class="body-svg" viewBox="0 0 200 420" xmlns="http://www.w3.org/2000/svg" aria-hidden="false" role="img">
              <!-- simplified body -->
              <defs>
                <style>.b{stroke:#c9b29a; stroke-width:3; fill:#fff0e6;}</style>
              </defs>
              <g transform="translate(0,10)">
                <ellipse cx="100" cy="50" rx="36" ry="30" fill="#fff" stroke="#c9b29a" stroke-width="2"></ellipse>
                <rect x="64" y="80" width="72" height="100" rx="22" ry="22" fill="#fff" stroke="#c9b29a" stroke-width="2"></rect>
                <rect x="40" y="190" width="120" height="160" rx="20" ry="20" fill="#fff" stroke="#c9b29a" stroke-width="2"></rect>
                <!-- left arm -->
                <rect x="8" y="90" width="28" height="110" rx="14" ry="14" fill="#fff" stroke="#c9b29a" stroke-width="2"></rect>
                <!-- right arm -->
                <rect x="164" y="90" width="28" height="110" rx="14" ry="14" fill="#fff" stroke="#c9b29a" stroke-width="2"></rect>
                <!-- left leg -->
                <rect x="60" y="350" width="30" height="70" rx="12" ry="12" fill="#fff" stroke="#c9b29a" stroke-width="2"></rect>
                <!-- right leg -->
                <rect x="110" y="350" width="30" height="70" rx="12" ry="12" fill="#fff" stroke="#c9b29a" stroke-width="2"></rect>
              </g>

              <!-- hotspots (transparent shapes covering regions) -->
              <g id="hotspots" fill="transparent" stroke="none">
                <!-- head -->
                <ellipse class="body-hotspot" id="hot_head" cx="100" cy="50" rx="36" ry="30"></ellipse>
                <!-- chest -->
                <rect class="body-hotspot" id="hot_chest" x="64" y="80" width="72" height="60" rx="12" ry="12"></rect>
                <!-- abdomen -->
                <rect class="body-hotspot" id="hot_abdomen" x="64" y="140" width="72" height="60" rx="12" ry="12"></rect>
                <!-- left hand -->
                <rect class="body-hotspot" id="hot_lhand" x="8" y="160" width="28" height="60" rx="12" ry="12"></rect>
                <!-- right hand -->
                <rect class="body-hotspot" id="hot_rhand" x="164" y="160" width="28" height="60" rx="12" ry="12"></rect>
                <!-- left leg -->
                <rect class="body-hotspot" id="hot_lleg" x="60" y="350" width="30" height="70" rx="12" ry="12"></rect>
                <!-- right leg -->
                <rect class="body-hotspot" id="hot_rleg" x="110" y="350" width="30" height="70" rx="12" ry="12"></rect>
              </g>
            </svg>
          </div>

          <div style="margin-top:10px; color:#6b5a46; font-size:13px;">é»é¸èº«é«”éƒ¨ä½ï¼ŒApp æœƒæœ—è®€å¦‚ã€Œæˆ‘é ­ç—›ã€ã€Œæˆ‘å³æ‰‹éº»ã€</div>
        </div>
      </section>

      <section id="builder-section" class="card" style="display:none;" aria-hidden="true">
        <div class="section-title">çµ„åˆå¥å­</div>
        <div style="margin-bottom:10px; color:#6b5a46;">é»é¸è©å½™å»ºç«‹å¥å­ï¼Œä¹Ÿå¯åœ¨æ­¤æœ—è®€æˆ–å„²å­˜æˆã€Œæˆ‘çš„å¸¸ç”¨å¥ã€ã€‚</div>

        <div class="sentence-area" id="sentence-area" style="min-height:72px; margin-bottom:12px;">
          <!-- chips -->
        </div>

        <div style="display:flex; gap:8px; margin-bottom:12px;">
          <button id="speak-btn" class="word-btn" style="flex:1; min-height:56px;">ğŸ”Š æœ—è®€</button>
          <button id="undo-btn" class="word-btn" style="min-width:120px; background:#fff2d6; color:#3d2f20;">â¬…ï¸ åˆªé™¤</button>
          <button id="clear-btn" class="word-btn" style="min-width:120px; background:#ffe4b3; color:#3d2f20;">âŒ æ¸…é™¤</button>
        </div>

        <div id="builder-grid" class="grid-2">
          <!-- builder words injected -->
        </div>
      </section>

      <section id="settings-section" class="card" style="display:none;" aria-hidden="true">
        <div class="section-title">è¨­å®š</div>

        <div style="margin-bottom:12px;">
          <label for="lang-select" style="display:block; margin-bottom:6px;">æœ—è®€èªè¨€</label>
          <select id="lang-select" class="select" style="width:100%; padding:10px; border-radius:12px; border:1px solid rgba(0,0,0,0.05);">
            <option value="zh-TW">ä¸­æ–‡ï¼ˆå°ç£ï¼‰</option>
            <option value="en-US">English</option>
            <option value="id-ID">Bahasa Indonesia</option>
            <option value="vi-VN">Tiáº¿ng Viá»‡t</option>
            <option value="tl-PH">Tagalog</option>
          </select>
        </div>

        <div style="margin-bottom:12px;">
          <label style="display:block; margin-bottom:6px;">æŒ‰éˆ•å¤§å°</label>
          <div style="display:flex; gap:8px;">
            <button class="word-btn" id="size-small" style="flex:1; min-height:48px;">å°</button>
            <button class="word-btn" id="size-medium" style="flex:1; min-height:48px;">ä¸­ï¼ˆé è¨­ï¼‰</button>
            <button class="word-btn" id="size-large" style="flex:1; min-height:48px;">å¤§</button>
          </div>
        </div>

        <div style="margin-top:8px;">
          <button id="voice-test" class="word-btn" style="width:100%;">ğŸ”ˆ è©¦è½æœ—è®€ï¼ˆæ¸¬è©¦å°ç£èªéŸ³ï¼‰</button>
        </div>
      </section>

    </div>
  </main>

  <!-- bottom nav: ä¸€éµæ±‚åŠ© ï½œ æƒ…ç·’/èº«é«” ï½œ çµ„åˆå¥å­ ï½œ è¨­å®š -->
  <nav class="bottom-nav" role="navigation" aria-label="ä¸»è¦åŠŸèƒ½">
    <button class="nav-btn" id="nav-quick" aria-pressed="true">
      <div style="font-size:18px;">ğŸ </div>
      ä¸€éµæ±‚åŠ©
    </button>
    <button class="nav-btn" id="nav-emotion">
      <div style="font-size:18px;">ğŸ’“</div>
      æƒ…ç·’ / èº«é«”
    </button>
    <button class="nav-btn" id="nav-builder">
      <div style="font-size:18px;">ğŸ’¬</div>
      çµ„åˆå¥å­
    </button>
    <button class="nav-btn" id="nav-settings">
      <div style="font-size:18px;">âš™ï¸</div>
      è¨­å®š
    </button>
  </nav>

  <!-- modal template for custom words -->
  <div id="modal" style="display:none;" class="modal" role="dialog" aria-modal="true">
    <div class="modal-card">
      <div style="font-weight:700; margin-bottom:8px;">æ–°å¢è©å½™</div>
      <input id="modal-zh" placeholder="ä¸­æ–‡ï¼ˆå¿…å¡«ï¼‰" style="width:100%; padding:10px; border-radius:10px; border:1px solid rgba(0,0,0,0.06); margin-bottom:8px;">
      <input id="modal-foreign" placeholder="å¤–èªï¼ˆé¸å¡«ï¼‰" style="width:100%; padding:10px; border-radius:10px; border:1px solid rgba(0,0,0,0.06); margin-bottom:12px;">
      <div style="display:flex; gap:8px;">
        <button id="modal-save" class="word-btn" style="flex:1;">å„²å­˜</button>
        <button id="modal-cancel" class="word-btn" style="flex:1; background:#fff2f0;">å–æ¶ˆ</button>
      </div>
    </div>
  </div>
</div>

<script>
/* AAC v30 â€” JS
   åŠŸèƒ½é‡é»ï¼š
   - å¿«é€ŸæŒ‰éˆ•ï¼ˆquickï¼‰
   - æƒ…ç·’æ¿ + äººé«”ç†±é»ï¼ˆemotionï¼‰
   - çµ„åˆå¥å­ (builder)
   - èªéŸ³é¸æ“‡ï¼šå„ªå…ˆ zh-TW å°ç£å£éŸ³ï¼ˆè‹¥å¯ç”¨ï¼‰
   - iPad/æ¡Œé¢ä»¥å¯¬åº¦è‡ªå‹•é›™æ¬„é¡¯ç¤ºï¼ˆæ¨£å¼åœ¨ CSSï¼‰
*/

/* --- åˆå§‹è©å½™ï¼ˆä¿ç•™åŸ emoji èˆ‡å¤šèªï¼‰ --- */
const QUICK = [
  {id:'help', emoji:'ğŸ†˜', zh:'å¹«æˆ‘', en:'Help me'},
  {id:'pain', emoji:'ğŸ˜«', zh:'æˆ‘ç—›', en:"I'm in pain"},
  {id:'pee', emoji:'ğŸš½', zh:'æˆ‘æƒ³å°ä¾¿', en:"I need to pee"},
  {id:'poop', emoji:'ğŸ’©', zh:'æˆ‘æƒ³å¤§ä¾¿', en:"I need to poop"},
  {id:'thirsty', emoji:'ğŸ’§', zh:'æˆ‘æ¸´äº†', en:"I'm thirsty"},
  {id:'hungry', emoji:'ğŸ˜‹', zh:'æˆ‘é¤“äº†', en:"I'm hungry"},
  {id:'breathless', emoji:'ğŸ˜®â€ğŸ’¨', zh:'å‘¼å¸å›°é›£', en:"Difficulty breathing"}
];

const BUILDER = {
  "ä¸»è©":[{id:'me', zh:'æˆ‘'},{id:'you', zh:'ä½ '},{id:'doctor', zh:'é†«ç”Ÿ'}],
  "å‹•è©/éœ€æ±‚":[{id:'want', zh:'æƒ³'},{id:'need', zh:'è¦'},{id:'eat', zh:'åƒ'},{id:'drink', zh:'å–'}],
  "æ„Ÿå—":[{id:'pain', zh:'ç—›'},{id:'cold', zh:'å†·'},{id:'tired', zh:'ç´¯'}],
  "ç‰©å“":[{id:'water', zh:'æ°´'},{id:'bed', zh:'åºŠ'}]
};

const EMOTIONS = [
  {id:'sad', emoji:'ğŸ˜¢', zh:'é›£é', sentence:'æˆ‘è¦ºå¾—é›£é'},
  {id:'angry', emoji:'ğŸ˜¡', zh:'ç”Ÿæ°£', sentence:'æˆ‘è¦ºå¾—ç”Ÿæ°£'},
  {id:'happy', emoji:'ğŸ˜„', zh:'é–‹å¿ƒ', sentence:'æˆ‘è¦ºå¾—å¾ˆé–‹å¿ƒ'},
  {id:'sleepy', emoji:'ğŸ¥±', zh:'æƒ³ç¡', sentence:'æˆ‘æƒ³ç¡è¦º'},
  {id:'anxious', emoji:'ğŸ˜–', zh:'ç·Šå¼µ', sentence:'æˆ‘è¦ºå¾—å¾ˆç·Šå¼µ'},
  {id:'lonely', emoji:'ğŸ˜Ÿ', zh:'å¯‚å¯', sentence:'æˆ‘è¦ºå¾—å¾ˆå¯‚å¯'}
];

/* èº«é«”éƒ¨ä½å°æ‡‰å¥ */
const BODY_MAP = {
  hot_head: {label:'é ­', sentence:'æˆ‘é ­ç—›'},
  hot_chest: {label:'èƒ¸å£', sentence:'æˆ‘èƒ¸æ‚¶'},
  hot_abdomen: {label:'è‚šå­', sentence:'æˆ‘è‚šå­ç—›'},
  hot_lhand: {label:'å·¦æ‰‹', sentence:'æˆ‘å·¦æ‰‹éº»'},
  hot_rhand: {label:'å³æ‰‹', sentence:'æˆ‘å³æ‰‹éº»'},
  hot_lleg: {label:'å·¦è…³', sentence:'æˆ‘å·¦è…³ç—›'},
  hot_rleg: {label:'å³è…³', sentence:'æˆ‘å³è…³ç—›'}
};

/* --- state --- */
let currentLang = localStorage.getItem('aac_lang') || 'zh-TW';
let currentSentence = [];
let synth = window.speechSynthesis;
let voices = [];

/* DOM refs */
const quickGrid = document.getElementById('quick-grid');
const builderGrid = document.getElementById('builder-grid');
const builderSection = document.getElementById('builder-section');
const quickSection = document.getElementById('quick-section');
const emotionSection = document.getElementById('emotion-section');
const settingsSection = document.getElementById('settings-section');
const sentenceArea = document.getElementById('sentence-area');

const navQuick = document.getElementById('nav-quick');
const navEmotion = document.getElementById('nav-emotion');
const navBuilder = document.getElementById('nav-builder');
const navSettings = document.getElementById('nav-settings');

const tabs = document.querySelectorAll('.tab');

const langSelect = document.getElementById('lang-select');
langSelect.value = currentLang;

/* load voices */
function loadVoices(){
  voices = synth.getVoices() || [];
}
loadVoices();
if (synth.onvoiceschanged !== undefined) synth.onvoiceschanged = loadVoices;

/* helper: attempt to pick a zh-TW voice; fallback gracefully */
function pickVoiceForLang(lang){
  // Ensure voices loaded
  const v = voices.slice();
  if(!v.length) return null;
  // prefer exact match with zh-TW and likely "Google" or contains "Taiwan" in name
  if(lang === 'zh-TW'){
    let candidate = v.find(x => x.lang === 'zh-TW' && (x.name.includes('Google') || /Taiwan|å°ç£|zh_TW|Taiwanese/i.test(x.name)));
    if(candidate) return candidate;
    candidate = v.find(x => x.lang.startsWith('zh') && (x.name.includes('Google') || /Taiwan|å°ç£|zh_TW|Taiwanese/i.test(x.name)));
    if(candidate) return candidate;
    // otherwise first zh voice
    candidate = v.find(x => x.lang.startsWith('zh'));
    if(candidate) return candidate;
  } else {
    // non-zh: try exact lang, else prefix
    let candidate = v.find(x => x.lang === lang || x.lang.startsWith(lang.split('-')[0]));
    if(candidate) return candidate;
  }
  // fallback to first available
  return v[0];
}

function speak(text, opts = {}){
  if(!text) return;
  // vibrate for tactile feedback if available
  if(navigator.vibrate) navigator.vibrate(40);
  const utt = new SpeechSynthesisUtterance(text);
  const lang = opts.lang || currentLang || 'zh-TW';
  utt.lang = lang;
  const voice = pickVoiceForLang(lang);
  if(voice) utt.voice = voice;
  // reading rate - chinese slightly faster
  utt.rate = (lang === 'zh-TW') ? 0.9 : 0.85;
  // flash UI element if provided
  if(opts.el){
    opts.el.classList.add('flash');
    setTimeout(()=>opts.el.classList.remove('flash'), 320);
  }
  // speak (cancel previous)
  try{ synth.cancel(); } catch(e){}
  synth.speak(utt);
}

/* render quick buttons */
function renderQuick(){
  quickGrid.innerHTML = '';
  QUICK.forEach(w=>{
    const btn = document.createElement('button');
    btn.className = 'word-btn';
    btn.innerHTML = `<div class="word-emoji">${w.emoji}</div><div class="word-label">${w.zh}</div>`;
    btn.onclick = ()=> {
      speak(w[currentLang.split('-')[0] === 'zh' ? 'zh' : 'en'], {el:btn});
      // for critical ones (help/pain) also append to sentence
      if(w.id === 'help' || w.id === 'pain'){
        pushToSentence({text:w.zh});
      }
    };
    quickGrid.appendChild(btn);
  });
}

/* render builder grid */
function renderBuilder(){
  builderGrid.innerHTML = '';
  for(const cat in BUILDER){
    const group = BUILDER[cat];
    group.forEach(item=>{
      const btn = document.createElement('button');
      btn.className = 'word-btn';
      btn.innerHTML = `<div class="word-label">${item.zh}</div>`;
      btn.onclick = ()=> {
        pushToSentence({text:item.zh});
      };
      builderGrid.appendChild(btn);
    });
    // add "æ–°å¢" for each category (simple global modal)
    const addBtn = document.createElement('button');
    addBtn.className = 'word-btn';
    addBtn.style.background = '#fff8f0';
    addBtn.innerHTML = `<div class="word-label">ï¼‹ æ–°å¢è©å½™</div>`;
    addBtn.onclick = ()=> showModal();
    builderGrid.appendChild(addBtn);
  }
}

/* push to sentence */
function pushToSentence(wordObj){
  currentSentence.push(wordObj);
  refreshSentenceUI();
}

/* refresh sentence UI */
function refreshSentenceUI(){
  sentenceArea.innerHTML = '';
  if(currentSentence.length === 0){
    sentenceArea.innerHTML = '<div style="color:#9b8b76;">ï¼ˆå°šæœªæ–°å¢è©å½™ï¼‰</div>';
    return;
  }
  currentSentence.forEach((w, idx)=>{
    const chip = document.createElement('div');
    chip.className = 'sentence-chip';
    chip.textContent = w.text || w.zh || w;
    chip.onclick = ()=> {
      // optional: remove if tapped long? simple remove on click with confirm
      currentSentence.splice(idx,1);
      refreshSentenceUI();
    };
    sentenceArea.appendChild(chip);
  });
}

/* nav handlers */
navQuick.addEventListener('click', ()=> showView('quick'));
navEmotion.addEventListener('click', ()=> showView('emotion'));
navBuilder.addEventListener('click', ()=> showView('builder'));
navSettings.addEventListener('click', ()=> showView('settings'));

function clearActiveNav(){
  [navQuick, navEmotion, navBuilder, navSettings].forEach(n=>n.classList.remove('active'));
}
function showView(name){
  clearActiveNav();
  document.getElementById('quick-section').style.display='none';
  document.getElementById('emotion-section').style.display='none';
  document.getElementById('builder-section').style.display='none';
  document.getElementById('settings-section').style.display='none';

  if(name === 'quick'){
    navQuick.classList.add('active');
    document.getElementById('quick-section').style.display='block';
    document.getElementById('quick-section').setAttribute('aria-hidden','false');
  } else if(name === 'emotion'){
    navEmotion.classList.add('active');
    document.getElementById('emotion-section').style.display='block';
    document.getElementById('emotion-section').setAttribute('aria-hidden','false');
  } else if(name === 'builder'){
    navBuilder.classList.add('active');
    document.getElementById('builder-section').style.display='block';
    document.getElementById('builder-section').setAttribute('aria-hidden','false');
  } else if(name === 'settings'){
    navSettings.classList.add('active');
    document.getElementById('settings-section').style.display='block';
    document.getElementById('settings-section').setAttribute('aria-hidden','false');
  }
  // scroll to top for readability
  document.getElementById('main').scrollTo({top:0, behavior:'smooth'});
}

/* emotion render */
function renderEmotions(){
  const grid = document.getElementById('emotion-grid');
  grid.innerHTML = '';
  EMOTIONS.forEach(e=>{
    const btn = document.createElement('button');
    btn.className = 'word-btn';
    btn.innerHTML = `<div class="word-emoji">${e.emoji}</div><div class="word-label">${e.zh}</div>`;
    btn.onclick = ()=> {
      speak(e.sentence);
      pushToSentence({text:e.sentence});
    };
    grid.appendChild(btn);
  });
}

/* body hotspots */
Object.keys(BODY_MAP).forEach(k=>{
  const el = document.getElementById(k);
  if(!el) return;
  el.addEventListener('click', ()=>{
    const info = BODY_MAP[k];
    // visual feedback
    el.classList.add('hot-active');
    setTimeout(()=>el.classList.remove('hot-active'), 300);
    speak(info.sentence);
    pushToSentence({text: info.sentence});
  });
  // also keyboard accessible
  el.setAttribute('tabindex', 0);
  el.addEventListener('keydown', (ev)=>{
    if(ev.key === 'Enter' || ev.key === ' '){
      ev.preventDefault();
      el.click();
    }
  });
});

/* tabs for emotion/body */
tabs.forEach(t=>{
  t.addEventListener('click', ()=> {
    tabs.forEach(x=>x.classList.remove('active'));
    t.classList.add('active');
    const tab = t.dataset.tab;
    if(tab === 'emotion'){ document.getElementById('emotion-panel').style.display='block'; document.getElementById('body-panel').style.display='none'; }
    else { document.getElementById('emotion-panel').style.display='none'; document.getElementById('body-panel').style.display='block'; }
  });
});

/* settings controls */
document.getElementById('voice-test').addEventListener('click', ()=> {
  speak('é€™æ˜¯èªéŸ³æ¸¬è©¦ï¼Œç¾åœ¨ä½¿ç”¨å°ç£ä¸­æ–‡ç™¼éŸ³ã€‚', {lang:'zh-TW'});
});

langSelect.addEventListener('change', ()=>{
  currentLang = langSelect.value;
  localStorage.setItem('aac_lang', currentLang);
});

/* size buttons */
document.getElementById('size-small').addEventListener('click', ()=> setBtnSize('small'));
document.getElementById('size-medium').addEventListener('click', ()=> setBtnSize('medium'));
document.getElementById('size-large').addEventListener('click', ()=> setBtnSize('large'));

function setBtnSize(size){
  const styleMap = {
    small: {min:'56px', font:'16px'},
    medium: {min:'68px', font:'18px'},
    large: {min:'86px', font:'20px'}
  };
  const s = styleMap[size];
  document.querySelectorAll('.word-btn').forEach(b=>{
    b.style.minHeight = s.min;
    b.style.fontSize = s.font;
  });
}

/* builder actions */
document.getElementById('speak-btn').addEventListener('click', ()=>{
  if(currentSentence.length === 0) {
    speak('å°šæœªæœ‰å¥å­');
    return;
  }
  // join by '' for Chinese
  const txt = currentSentence.map(c => c.text || c.zh || c).join('');
  speak(txt, {lang: currentLang});
});
document.getElementById('undo-btn').addEventListener('click', ()=>{
  currentSentence.pop();
  refreshSentenceUI();
});
document.getElementById('clear-btn').addEventListener('click', ()=>{
  if(confirm('ç¢ºèªè¦æ¸…é™¤å¥å­å—ï¼Ÿ')){
    currentSentence = [];
    refreshSentenceUI();
  }
});

/* modal: new custom word */
const modal = document.getElementById('modal');
const modalSave = document.getElementById('modal-save');
const modalCancel = document.getElementById('modal-cancel');
function showModal(){ modal.style.display='flex'; document.getElementById('modal-zh').focus(); }
modalCancel.addEventListener('click', ()=> modal.style.display='none');
modalSave.addEventListener('click', ()=>{
  const zh = document.getElementById('modal-zh').value.trim();
  const foreign = document.getElementById('modal-foreign').value.trim();
  if(!zh){ alert('ä¸­æ–‡ç‚ºå¿…å¡«'); return; }
  // push to builder first category (ç°¡å–®å¯¦ä½œ)
  BUILDER['ä¸»è©'].push({id:'custom_'+Date.now(), zh});
  renderBuilder();
  modal.style.display='none';
});

/* initial render */
renderQuick();
renderBuilder();
renderEmotions();
refreshSentenceUI();
showView('quick');

/* ensure body hotspots listeners exist after DOM paint */
setTimeout(()=>{
  Object.keys(BODY_MAP).forEach(k=>{
    const el = document.getElementById(k);
    if(el){
      // ensure pointer events
      el.style.pointerEvents = 'auto';
    }
  });
}, 150);

/* accessibility: keyboard nav for bottom nav */
[navQuick, navEmotion, navBuilder, navSettings].forEach((n, idx)=>{
  n.setAttribute('tabindex', 0);
  n.addEventListener('keydown', (e)=>{ if(e.key === 'Enter' || e.key === ' ') n.click(); });
});

/* ensure voices loaded on some browsers */
window.addEventListener('load', ()=>{ setTimeout(loadVoices, 200); });

</script>
</body>
</html>
