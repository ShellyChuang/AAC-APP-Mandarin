<!doctype html>
<html lang="zh-TW">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>AAC v31 â€” æƒ…ç·’èˆ‡èº«é«”äº’å‹•æ¿ï¼ˆæš–è‰²ç‰ˆï¼‰</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#fdfaf6; --accent:#d4b483; --accent-2:#f8e8b5; --muted:#7a6a55;
  --card:#fff; --shadow:0 6px 18px rgba(17,15,12,0.06); --radius:18px; --btn-h:68px;
  --safe-bottom:env(safe-area-inset-bottom,12px);
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;padding:0;font-family:'Noto Sans TC',system-ui,-apple-system; background:var(--bg); color:#2b2b2b;}
.app{display:flex;flex-direction:column;height:100vh;}
header{padding:12px 16px;}
.title{font-weight:700;color:var(--muted);font-size:20px;}
main{flex:1;overflow:auto;padding-bottom:calc(var(--btn-h) + var(--safe-bottom) + 20px);}

/* å¡ç‰‡ */
.card{background:var(--card);margin:12px 16px;border-radius:var(--radius);box-shadow:var(--shadow);padding:14px;}
.section-title{font-weight:700;color:#3d2f20;margin-bottom:8px;font-size:16px;}

/* åº•éƒ¨å°èˆª */
.bottom-nav{position:fixed;left:0;right:0;bottom:0;height:calc(var(--btn-h)+var(--safe-bottom));padding-bottom:var(--safe-bottom);background:linear-gradient(180deg,rgba(255,255,255,0.6),rgba(255,255,255,0.95));border-top:1px solid rgba(0,0,0,0.04);display:flex;z-index:60;align-items:center;justify-content:space-around;}
.nav-btn{flex:1;height:var(--btn-h);display:flex;align-items:center;justify-content:center;gap:6px;flex-direction:column;border:none;background:transparent;font-weight:600;color:#8a7a63;font-size:13px;cursor:pointer;}
.nav-btn.active{color:var(--accent);}

/* æŒ‰éˆ•æ ¼ */
.grid-2{display:grid;grid-template-columns:repeat(2,1fr);gap:14px;}
.grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;}
.word-btn{background:linear-gradient(180deg,#fff,#fff);border-radius:14px;padding:10px;display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:86px;font-weight:700;box-shadow:0 6px 14px rgba(0,0,0,0.04);border:1px solid rgba(0,0,0,0.03);cursor:pointer;user-select:none;}
.word-emoji{font-size:34px;margin-bottom:6px;}
.word-label{font-size:18px;color:#3d2f20;}

/* å¥å­å€ */
.sentence-area{display:flex;gap:10px;flex-wrap:wrap;align-items:center;padding:12px;border-radius:12px;background:linear-gradient(180deg,#fff,#faf7f2);border:1px solid rgba(0,0,0,0.03);min-height:72px;}
.sentence-chip{background:var(--accent-2);padding:8px 12px;border-radius:12px;font-weight:700;color:#3b2e1f;box-shadow:0 2px 6px rgba(0,0,0,0.04);}

/* æƒ…ç·’/èº«é«” tabs */
.tabs{display:flex;gap:8px;padding:8px;}
.tab{padding:8px 12px;border-radius:12px;background:transparent;border:1px solid rgba(0,0,0,0.03);font-weight:600;cursor:pointer;}
.tab.active{background:var(--accent);color:#fff;}

/* äººé«”ç¤ºæ„ */
.body-wrap{display:flex;gap:12px;align-items:center;justify-content:center;padding:8px;}
.body-svg{width:260px;max-width:60vw;height:auto;touch-action:manipulation;user-select:none;}
.body-hotspot{fill:transparent;cursor:pointer;transition:fill .15s ease, transform .08s ease;}
.hot-active{fill:rgba(212,180,131,0.16);transform:scale(1.02);}

/* ç‹€æ³å½ˆçª—ï¼ˆå®šä½æ–¼é»æ“Šé™„è¿‘ï¼‰ */
.popup{position:fixed;z-index:200;background:var(--card);border-radius:12px;padding:8px;box-shadow:var(--shadow);border:1px solid rgba(0,0,0,0.04);min-width:180px;}
.popup .status-btn{display:inline-block;margin:6px;padding:8px 10px;border-radius:10px;background:linear-gradient(180deg,#fff,#fff);border:1px solid rgba(0,0,0,0.06);cursor:pointer;font-weight:700;}

/* è¨­å®šçš„ç‹€æ³è©å½™æ¨™ç±¤ */
.tags{display:flex;flex-wrap:wrap;gap:8px;}
.tag{background:var(--accent-2);padding:8px 10px;border-radius:999px;display:inline-flex;align-items:center;gap:8px;}
.tag .remove{background:transparent;border:none;font-weight:700;color:#7a5f3e;cursor:pointer;}

/* modal template */
.modal{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.32);z-index:300;}
.modal-card{background:var(--card);padding:16px;border-radius:14px;width:92%;max-width:420px;box-shadow:var(--shadow);}

/* responsive: iPad landscape -> 2col layout */
@media (min-width:900px){
  main{padding-left:20px;padding-right:20px;}
  .two-col{display:flex;gap:16px;align-items:flex-start;}
  .left-col{flex:0 0 340px;}
  .right-col{flex:1;}
  .grid-2{grid-template-columns:repeat(3,1fr);}
  .body-svg{width:320px;}
}

/* small animations */
.flash{animation: flash 320ms ease-out;}
@keyframes flash {0%{box-shadow:0 0 0 8px rgba(248,232,181,0.40);}100%{box-shadow:none;}}
</style>
</head>
<body>
<div class="app" role="application" aria-label="è¼”åŠ©æºé€šæ‡‰ç”¨ AAC v31">
  <header><div class="title">AAC v31 â€” æƒ…ç·’èˆ‡èº«é«”ï¼ˆæš–è‰²ï¼‰</div></header>
  <main id="main">

    <!-- Quick / Emotion / Builder / Settings sections -->
    <section id="quick-section" class="card" aria-hidden="false">
      <div class="section-title">ä¸€éµæ±‚åŠ©</div>
      <p style="margin:0 0 10px 0;color:#6b5a46;">æŒ‰ä¸€ä¸‹æœƒæœ—è®€ï¼ˆä¸æœƒåŠ å…¥çµ„åˆå¥å­ï¼‰</p>
      <div id="quick-grid" class="grid-2"></div>
    </section>

    <section id="emotion-section" class="card" style="display:none;" aria-hidden="true">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <div class="section-title">æƒ…ç·’èˆ‡èº«é«”éƒ¨ä½</div>
        <div style="font-size:13px;color:#8a7a63;">é»æ“Šåœ–å½¢æˆ–æŒ‰éˆ•ä»¥é¸æ“‡ç‹€æ³ä¸¦æœ—è®€</div>
      </div>

      <div class="tabs" style="margin-top:10px;">
        <button class="tab active" data-tab="emotion">æƒ…ç·’æ¿</button>
        <button class="tab" data-tab="body">èº«é«”åœ°åœ–</button>
      </div>

      <div id="emotion-panel" style="margin-top:10px;">
        <div id="emotion-grid" class="grid-2"></div>
      </div>

      <div id="body-panel" style="display:none;margin-top:12px;">
        <div class="body-wrap">
          <!-- friendly SVG human illustration (å¯æ›¿æ›ç‚ºç”± .ai è½‰å‡ºçš„ SVG) -->
          <svg class="body-svg" viewBox="0 0 260 520" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="äººé«”ç¤ºæ„åœ–">
            <!-- a soft-line human shape (stylized) -->
            <g stroke="#c9b29a" stroke-width="3" fill="none" transform="translate(0,4)">
              <ellipse cx="130" cy="48" rx="36" ry="28" fill="#fff6f0" stroke="#c9b29a" stroke-width="2"></ellipse>
              <path d="M92 78 q38 28 76 0 v56 q0 18 -24 18 h-28 q-24 0 -24 -18 z" fill="#fff6f0" stroke="#c9b29a" stroke-width="2"></path>
              <rect x="70" y="154" width="120" height="170" rx="26" ry="26" fill="#fff6f0" stroke="#c9b29a" stroke-width="2"></rect>
              <rect x="26" y="92" width="34" height="120" rx="18" ry="18" fill="#fff6f0" stroke="#c9b29a" stroke-width="2"></rect>
              <rect x="200" y="92" width="34" height="120" rx="18" ry="18" fill="#fff6f0" stroke="#c9b29a" stroke-width="2"></rect>
              <rect x="76" y="332" width="34" height="120" rx="14" ry="14" fill="#fff6f0" stroke="#c9b29a" stroke-width="2"></rect>
              <rect x="150" y="332" width="34" height="120" rx="14" ry="14" fill="#fff6f0" stroke="#c9b29a" stroke-width="2"></rect>
            </g>
            <!-- Hotspots (transparent but clickable) -->
            <g id="hotspots" fill="transparent">
              <ellipse id="hs_head" class="body-hotspot" cx="130" cy="48" rx="36" ry="28"></ellipse>
              <rect id="hs_chest" class="body-hotspot" x="92" y="78" width="76" height="54" rx="10" ry="10"></rect>
              <rect id="hs_abdomen" class="body-hotspot" x="92" y="132" width="76" height="74" rx="10" ry="10"></rect>
              <rect id="hs_lhand" class="body-hotspot" x="26" y="92" width="34" height="120" rx="18" ry="18"></rect>
              <rect id="hs_rhand" class="body-hotspot" x="200" y="92" width="34" height="120" rx="18" ry="18"></rect>
              <rect id="hs_lleg" class="body-hotspot" x="76" y="332" width="34" height="120" rx="14" ry="14"></rect>
              <rect id="hs_rleg" class="body-hotspot" x="150" y="332" width="34" height="120" rx="14" ry="14"></rect>
            </g>
          </svg>
        </div>
        <div style="margin-top:10px;color:#6b5a46;font-size:13px;">é»é¸èº«é«”éƒ¨ä½ï¼Œæ¥è‘—å¾å½ˆå‡ºé¸å–®é¸æ“‡ã€Œç—› / éº» / ç™¢ / ç— ã€æˆ–ä½ åœ¨è¨­å®šä¸­è‡ªè¨‚çš„è©å½™ã€‚</div>
      </div>
    </section>

    <section id="builder-section" class="card" style="display:none;" aria-hidden="true">
      <div class="section-title">çµ„åˆå¥å­</div>
      <div style="margin-bottom:10px;color:#6b5a46;">é»é¸è©å½™å»ºç«‹å¥å­ï¼ˆå¿«é€Ÿèªå¥ä¸æœƒè‡ªå‹•åŠ å…¥æ­¤å€ï¼‰</div>
      <div id="sentence-area" class="sentence-area"></div>

      <div style="display:flex;gap:8px;margin:12px 0;">
        <button id="speak-btn" class="word-btn" style="flex:1;min-height:56px;">ğŸ”Š æœ—è®€</button>
        <button id="undo-btn" class="word-btn" style="min-width:120px;background:#fff2d6;color:#3d2f20;">â¬…ï¸ åˆªé™¤</button>
        <button id="clear-btn" class="word-btn" style="min-width:120px;background:#ffe4b3;color:#3d2f20;">âŒ æ¸…é™¤</button>
      </div>

      <div id="builder-grid" class="grid-2"></div>
    </section>

    <section id="settings-section" class="card" style="display:none;" aria-hidden="true">
      <div class="section-title">è¨­å®š</div>
      <div style="margin-bottom:12px;">
        <label for="lang-select" style="display:block;margin-bottom:6px;">æœ—è®€èªè¨€</label>
        <select id="lang-select" style="width:100%;padding:10px;border-radius:12px;border:1px solid rgba(0,0,0,0.05);">
          <option value="zh-TW">ä¸­æ–‡ï¼ˆå°ç£ï¼‰</option>
          <option value="en-US">English</option>
          <option value="id-ID">Bahasa Indonesia</option>
          <option value="vi-VN">Tiáº¿ng Viá»‡t</option>
          <option value="tl-PH">Tagalog</option>
        </select>
      </div>

      <div style="margin-bottom:12px;">
        <div style="margin-bottom:8px;font-weight:600;">ç‹€æ³è©å½™ï¼ˆé» âœ• å¯åˆªé™¤ï¼‰</div>
        <div id="status-tags" class="tags" style="margin-bottom:8px;"></div>
        <div style="display:flex;gap:8px;">
          <input id="new-status-input" placeholder="æ–°å¢ä¸€å€‹ç‹€æ³ï¼ˆä¾‹å¦‚ï¼šç†±ï¼‰" style="flex:1;padding:10px;border-radius:10px;border:1px solid rgba(0,0,0,0.06);">
          <button id="add-status-btn" class="word-btn" style="min-width:120px;background:#fff8f0;">ï¼‹ æ–°å¢</button>
        </div>
      </div>

      <div style="margin-top:6px;color:#7a6a55;font-size:13px;">é è¨­ç‹€æ³ï¼šç—›ã€éº»ã€ç™¢ã€ç— ï¼ˆå¯è‡ªè¡Œæ–°å¢/åˆªé™¤ï¼‰ã€‚</div>
    </section>
  </main>

  <nav class="bottom-nav" role="navigation" aria-label="ä¸»è¦åŠŸèƒ½">
    <button class="nav-btn active" id="nav-quick"> <div style="font-size:18px;">ğŸ </div> ä¸€éµæ±‚åŠ©</button>
    <button class="nav-btn" id="nav-emotion"> <div style="font-size:18px;">ğŸ’“</div> æƒ…ç·’ / èº«é«”</button>
    <button class="nav-btn" id="nav-builder"> <div style="font-size:18px;">ğŸ’¬</div> çµ„åˆå¥å­</button>
    <button class="nav-btn" id="nav-settings"> <div style="font-size:18px;">âš™ï¸</div> è¨­å®š</button>
  </nav>
</div>

<script>
/* AAC v31 JS
   - Quick buttons only speak (no push to builder)
   - Emotion buttons speak (no push to builder)
   - Body hotspots -> popup near click -> choose status (status list is editable in settings)
   - Status words default: ç—›, éº», ç™¢, ç—  (can add/delete)
   - Speech: localized according to selected language (fallback to zh-TW)
*/

/* ---------- initial data ---------- */
const QUICK = [
  {id:'help', emoji:'ğŸ†˜', text:{'zh-TW':'å¹«æˆ‘','en-US':'Help me','id-ID':'Tolong saya','vi-VN':'GiÃºp tÃ´i','tl-PH':'Tulungan mo ako'}},
  {id:'pain', emoji:'ğŸ˜«', text:{'zh-TW':'æˆ‘ç—›','en-US':"I'm in pain",'id-ID':'Saya sakit','vi-VN':'TÃ´i Ä‘au','tl-PH':'Masakit ako'}},
  {id:'pee', emoji:'ğŸš½', text:{'zh-TW':'æˆ‘æƒ³å°ä¾¿','en-US':"I need to pee",'id-ID':'Saya mau buang air kecil','vi-VN':'TÃ´i muá»‘n Ä‘i tiá»ƒu','tl-PH':'Gusto kong umihi'}},
  {id:'poop', emoji:'ğŸ’©', text:{'zh-TW':'æˆ‘æƒ³å¤§ä¾¿','en-US':"I need to poop",'id-ID':'Saya mau buang air besar','vi-VN':'TÃ´i muá»‘n Ä‘i Ä‘áº¡i tiá»‡n','tl-PH':'Gusto kong dumumi'}},
  {id:'thirsty', emoji:'ğŸ’§', text:{'zh-TW':'æˆ‘æ¸´äº†','en-US':"I'm thirsty",'id-ID':'Saya haus','vi-VN':'TÃ´i khÃ¡t','tl-PH':'Nauuhaw ako'}},
  {id:'hungry', emoji:'ğŸ˜‹', text:{'zh-TW':'æˆ‘é¤“äº†','en-US':"I'm hungry",'id-ID':'Saya lapar','vi-VN':'TÃ´i Ä‘Ã³i','tl-PH':'Gutom ako'}},
  {id:'breathless', emoji:'ğŸ˜®â€ğŸ’¨', text:{'zh-TW':'å‘¼å¸å›°é›£','en-US':'Difficulty breathing','id-ID':'Susah bernapas','vi-VN':'KhÃ³ thá»Ÿ','tl-PH':'Nahihirapang huminga'}}
];

const EMOTIONS = [
  {id:'sad', emoji:'ğŸ˜¢', texts:{'zh-TW':'æˆ‘è¦ºå¾—é›£é','en-US':'I feel sad','id-ID':'Saya sedih','vi-VN':'TÃ´i buá»“n','tl-PH':'Nalulungkot ako'}},
  {id:'angry', emoji:'ğŸ˜¡', texts:{'zh-TW':'æˆ‘è¦ºå¾—ç”Ÿæ°£','en-US':'I feel angry','id-ID':'Saya marah','vi-VN':'TÃ´i tá»©c giáº­n','tl-PH':'Galit ako'}},
  {id:'happy', emoji:'ğŸ˜„', texts:{'zh-TW':'æˆ‘è¦ºå¾—å¾ˆé–‹å¿ƒ','en-US':'I feel happy','id-ID':'Saya senang','vi-VN':'TÃ´i vui','tl-PH':'Masaya ako'}},
  {id:'sleepy', emoji:'ğŸ¥±', texts:{'zh-TW':'æˆ‘æƒ³ç¡è¦º','en-US':'I want to sleep','id-ID':'Saya ingin tidur','vi-VN':'TÃ´i muá»‘n ngá»§','tl-PH':'Gusto kong matulog'}},
  {id:'anxious', emoji:'ğŸ˜–', texts:{'zh-TW':'æˆ‘è¦ºå¾—å¾ˆç·Šå¼µ','en-US':'I feel anxious','id-ID':'Saya cemas','vi-VN':'TÃ´i lo láº¯ng','tl-PH':'Nababahala ako'}},
  {id:'lonely', emoji:'ğŸ˜Ÿ', texts:{'zh-TW':'æˆ‘è¦ºå¾—å¾ˆå¯‚å¯','en-US':'I feel lonely','id-ID':'Saya kesepian','vi-VN':'TÃ´i cÃ´ Ä‘Æ¡n','tl-PH':'Nalulungkot ako'}}
];

/* default status list (can edit in settings) */
let STATUS_LIST = JSON.parse(localStorage.getItem('aac_status_list') || 'null') || [
  {key:'pain', label:{'zh-TW':'ç—›','en-US':'hurt','id-ID':'sakit','vi-VN':'Ä‘au','tl-PH':'masakit'}},
  {key:'numb', label:{'zh-TW':'éº»','en-US':'numb','id-ID':'mati rasa','vi-VN':'tÃª','tl-PH':'manhid'}},
  {key:'itch', label:{'zh-TW':'ç™¢','en-US':'itchy','id-ID':'gatal','vi-VN':'ngá»©a','tl-PH':'makating'}},
  {key:'sore', label:{'zh-TW':'ç— ','en-US':'sore','id-ID':'pegal','vi-VN':'má»i','tl-PH':'sakit/masakit'}},
];

/* body part mapping - sentence templates per language */
const BODY_PARTS = {
  hs_head: {id:'head', label:{'zh-TW':'é ­','en-US':'head','id-ID':'kepala','vi-VN':'Ä‘áº§u','tl-PH':'ulo'}, template:{'zh-TW':(part,stat)=>`${part}${stat}`, 'en-US':(part,stat)=>`${part} ${stat}`, 'default':(p,s)=>p+' '+s}},
  hs_chest: {id:'chest', label:{'zh-TW':'èƒ¸å£','en-US':'chest','id-ID':'dada','vi-VN':'ngá»±c','tl-PH':'dibdib'}, template:{'zh-TW':(p,s)=>`${p}${s}`,'en-US':(p,s)=>`${p} ${s}`}},
  hs_abdomen: {id:'abdomen', label:{'zh-TW':'è‚šå­','en-US':'stomach','id-ID':'perut','vi-VN':'bá»¥ng','tl-PH':'tiyan'}, template:{'zh-TW':(p,s)=>`${p}${s}`,'en-US':(p,s)=>`${p} ${s}`}},
  hs_lhand: {id:'lhand', label:{'zh-TW':'å·¦æ‰‹','en-US':'left hand','id-ID':'tangan kiri','vi-VN':'tay trÃ¡i','tl-PH':'kaliwang kamay'}, template:{'zh-TW':(p,s)=>`${p}${s}`,'en-US':(p,s)=>`${p} ${s}`}},
  hs_rhand: {id:'rhand', label:{'zh-TW':'å³æ‰‹','en-US':'right hand','id-ID':'tangan kanan','vi-VN':'tay pháº£i','tl-PH':'kanang kamay'}, template:{'zh-TW':(p,s)=>`${p}${s}`,'en-US':(p,s)=>`${p} ${s}`}},
  hs_lleg: {id:'lleg', label:{'zh-TW':'å·¦è…³','en-US':'left leg','id-ID':'kaki kiri','vi-VN':'chÃ¢n trÃ¡i','tl-PH':'kaliwang paa'}, template:{'zh-TW':(p,s)=>`${p}${s}`,'en-US':(p,s)=>`${p} ${s}`}},
  hs_rleg: {id:'rleg', label:{'zh-TW':'å³è…³','en-US':'right leg','id-ID':'kaki kanan','vi-VN':'chÃ¢n pháº£i','tl-PH':'kanang paa'}, template:{'zh-TW':(p,s)=>`${p}${s}`,'en-US':(p,s)=>`${p} ${s}`}},
};

/* builder data */
const BUILDER = {
  "ä¸»è©":[{id:'me',zh:'æˆ‘'},{id:'you',zh:'ä½ '},{id:'doctor',zh:'é†«ç”Ÿ'}],
  "å‹•è©/éœ€æ±‚":[{id:'want',zh:'æƒ³'},{id:'need',zh:'è¦'},{id:'eat',zh:'åƒ'},{id:'drink',zh:'å–'}],
  "æ„Ÿå—":[{id:'pain',zh:'ç—›'},{id:'cold',zh:'å†·'},{id:'tired',zh:'ç´¯'}],
  "ç‰©å“":[{id:'water',zh:'æ°´'},{id:'bed',zh:'åºŠ'}]
};

/* ---------- state ---------- */
let currentLang = localStorage.getItem('aac_lang') || 'zh-TW';
let voices = window.speechSynthesis.getVoices() || [];
let currentSentence = [];

/* DOM refs */
const quickGrid = document.getElementById('quick-grid');
const emotionGrid = document.getElementById('emotion-grid');
const builderGrid = document.getElementById('builder-grid');
const sentenceArea = document.getElementById('sentence-area');
const langSelect = document.getElementById('lang-select');
const statusTags = document.getElementById('status-tags');
const newStatusInput = document.getElementById('new-status-input');
const addStatusBtn = document.getElementById('add-status-btn');

langSelect.value = currentLang;

/* load voices (some browsers load asynchronously) */
function loadVoices(){
  voices = window.speechSynthesis.getVoices() || [];
}
loadVoices();
if(window.speechSynthesis.onvoiceschanged !== undefined) window.speechSynthesis.onvoiceschanged = loadVoices;

/* pick voice for language preference (try to favor zh-TW) */
function pickVoiceForLang(lang){
  if(!voices.length) return null;
  if(lang === 'zh-TW'){
    let v = voices.find(v=>v.lang==='zh-TW' && (/Google|Taiwan|å°ç£|Zhuyin|Hsin|Yun/i.test(v.name)));
    if(v) return v;
    v = voices.find(v=>v.lang.startsWith('zh'));
    if(v) return v;
  } else {
    let v = voices.find(v=>v.lang===lang || v.lang.startsWith(lang.split('-')[0]));
    if(v) return v;
  }
  return voices[0];
}

/* speak localized text object or plain string */
function speakLocalized(textObj, langOverride){
  if(!textObj) return;
  const lang = langOverride || currentLang || 'zh-TW';
  let text;
  if(typeof textObj === 'string') text = textObj;
  else {
    text = textObj[lang] || textObj[lang.split('-')[0]] || textObj['zh-TW'] || Object.values(textObj)[0];
  }
  if(!text) return;
  if(navigator.vibrate) navigator.vibrate(40);
  const utt = new SpeechSynthesisUtterance(text);
  utt.lang = lang;
  const voice = pickVoiceForLang(lang);
  if(voice) utt.voice = voice;
  utt.rate = (lang==='zh-TW')?0.9:0.85;
  try{ window.speechSynthesis.cancel(); } catch(e){}
  window.speechSynthesis.speak(utt);
}

/* ---------- rendering ---------- */
function renderQuick(){
  quickGrid.innerHTML = '';
  QUICK.forEach(item=>{
    const btn = document.createElement('button');
    btn.className = 'word-btn';
    btn.innerHTML = `<div class="word-emoji">${item.emoji}</div><div class="word-label">${item.text['zh-TW']}</div>`;
    btn.onclick = ()=>{
      // é‡è¦ï¼šå¿«é€Ÿèªå¥åªæœ—è®€ï¼Œä¸åŠ å…¥çµ„åˆå¥
      speakLocalized(item.text);
      btn.classList.add('flash'); setTimeout(()=>btn.classList.remove('flash'),320);
    };
    quickGrid.appendChild(btn);
  });
}

function renderEmotions(){
  emotionGrid.innerHTML = '';
  EMOTIONS.forEach(e=>{
    const btn = document.createElement('button');
    btn.className='word-btn';
    btn.innerHTML = `<div class="word-emoji">${e.emoji}</div><div class="word-label">${e.texts['zh-TW']}</div>`;
    btn.onclick = ()=> {
      speakLocalized(e.texts);
      btn.classList.add('flash'); setTimeout(()=>btn.classList.remove('flash'),320);
      // ä¸åŠ å…¥çµ„åˆå¥
    };
    emotionGrid.appendChild(btn);
  });
}

function renderBuilder(){
  builderGrid.innerHTML = '';
  for(const cat in BUILDER){
    const arr = BUILDER[cat];
    arr.forEach(item=>{
      const btn = document.createElement('button');
      btn.className='word-btn';
      btn.innerHTML = `<div class="word-label">${item.zh}</div>`;
      btn.onclick = ()=> {
        pushToSentence({text:item.zh});
      };
      builderGrid.appendChild(btn);
    });
    const addBtn = document.createElement('button');
    addBtn.className='word-btn';
    addBtn.style.background='#fff8f0';
    addBtn.innerHTML=`<div class="word-label">ï¼‹ æ–°å¢è©å½™</div>`;
    addBtn.onclick = ()=> showAddModal();
    builderGrid.appendChild(addBtn);
  }
}

/* sentence functions */
function pushToSentence(obj){
  currentSentence.push(obj);
  refreshSentenceUI();
}
function refreshSentenceUI(){
  sentenceArea.innerHTML='';
  if(currentSentence.length===0){ sentenceArea.innerHTML='<div style="color:#9b8b76;">ï¼ˆå°šæœªæ–°å¢è©å½™ï¼‰</div>'; return; }
  currentSentence.forEach((w,i)=>{
    const chip=document.createElement('div'); chip.className='sentence-chip'; chip.textContent = w.text || w;
    chip.onclick = ()=>{ currentSentence.splice(i,1); refreshSentenceUI(); };
    sentenceArea.appendChild(chip);
  });
}

/* nav */
const navQuick = document.getElementById('nav-quick'), navEmotion = document.getElementById('nav-emotion'), navBuilder = document.getElementById('nav-builder'), navSettings = document.getElementById('nav-settings');
function clearNav(){ [navQuick,navEmotion,navBuilder,navSettings].forEach(n=>n.classList.remove('active')); }
function showView(name){
  clearNav();
  document.getElementById('quick-section').style.display='none';
  document.getElementById('emotion-section').style.display='none';
  document.getElementById('builder-section').style.display='none';
  document.getElementById('settings-section').style.display='none';
  if(name==='quick'){ navQuick.classList.add('active'); document.getElementById('quick-section').style.display='block'; }
  if(name==='emotion'){ navEmotion.classList.add('active'); document.getElementById('emotion-section').style.display='block'; }
  if(name==='builder'){ navBuilder.classList.add('active'); document.getElementById('builder-section').style.display='block'; }
  if(name==='settings'){ navSettings.classList.add('active'); document.getElementById('settings-section').style.display='block'; }
  document.getElementById('main').scrollTo({top:0,behavior:'smooth'});
}
navQuick.addEventListener('click', ()=> showView('quick'));
navEmotion.addEventListener('click', ()=> showView('emotion'));
navBuilder.addEventListener('click', ()=> showView('builder'));
navSettings.addEventListener('click', ()=> showView('settings'));

/* tabs for emotion/body */
document.querySelectorAll('.tab').forEach(t=>{
  t.addEventListener('click', ()=>{
    document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
    t.classList.add('active');
    if(t.dataset.tab==='emotion'){ document.getElementById('emotion-panel').style.display='block'; document.getElementById('body-panel').style.display='none'; }
    else { document.getElementById('emotion-panel').style.display='none'; document.getElementById('body-panel').style.display='block'; }
  });
});

/* settings: status tags */
function renderStatusTags(){
  statusTags.innerHTML='';
  STATUS_LIST.forEach((st,idx)=>{
    const tag = document.createElement('div'); tag.className='tag';
    const label = document.createElement('div'); label.textContent = st.label['zh-TW'];
    const rm = document.createElement('button'); rm.className='remove'; rm.textContent='âœ•';
    rm.onclick = ()=> { STATUS_LIST.splice(idx,1); saveStatuses(); renderStatusTags(); };
    tag.appendChild(label); tag.appendChild(rm);
    statusTags.appendChild(tag);
  });
}
function saveStatuses(){ localStorage.setItem('aac_status_list', JSON.stringify(STATUS_LIST)); }

/* add new status */
addStatusBtn.addEventListener('click', ()=>{
  const v = newStatusInput.value.trim();
  if(!v) return;
  // add default translations = use same text for other langs (user can adjust later if need)
  const key = 's_'+Date.now();
  const obj = {key, label:{'zh-TW':v,'en-US':v,'id-ID':v,'vi-VN':v,'tl-PH':v}};
  STATUS_LIST.push(obj); saveStatuses(); renderStatusTags(); newStatusInput.value='';
});

/* body hotspots behavior - show popup near click with status options */
function attachHotspots(){
  Object.keys(BODY_PARTS).forEach(hsId=>{
    const el = document.getElementById(hsId);
    if(!el) return;
    el.style.pointerEvents='auto';
    el.setAttribute('tabindex',0);
    el.addEventListener('click',(ev)=>{
      ev.stopPropagation();
      openStatusPopupNear(ev.clientX, ev.clientY, hsId);
    });
    el.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' ') { e.preventDefault(); const rect = el.getBoundingClientRect(); openStatusPopupNear(rect.left + rect.width/2, rect.top + rect.height/2, hsId); } });
  });
}

/* create popup and position near click; clickable statuses reflect chosen language */
let currentPopup = null;
function openStatusPopupNear(x,y, hsId){
  closeCurrentPopup();
  const popup = document.createElement('div'); popup.className='popup'; popup.style.left = (x+8)+'px'; popup.style.top = (y+8)+'px';
  // status buttons from STATUS_LIST
  STATUS_LIST.forEach(st=>{
    const btn = document.createElement('button'); btn.className='status-btn'; btn.textContent = st.label['zh-TW']; // default label shown in UI
    btn.onclick = ()=>{
      // compose sentence according to language
      const partInfo = BODY_PARTS[hsId];
      const lang = currentLang || 'zh-TW';
      const partLabel = partInfo.label[lang] || partInfo.label['zh-TW'];
      // find status label in selected lang
      const statusLabel = st.label[lang] || st.label['zh-TW'];
      // compose using template (for zh we prefer concatenation w/o space)
      const templateFn = partInfo.template[lang] || partInfo.template['en-US'] || partInfo.template['zh-TW'] || partInfo.template['default'];
      const sentence = templateFn(partLabel, statusLabel);
      speakLocalized( { [lang]: sentence, 'zh-TW': templateFn(partInfo.label['zh-TW'], st.label['zh-TW']) } , lang);
      // visual feedback: highlight hotspot briefly
      const el = document.getElementById(hsId); if(el){ el.classList.add('hot-active'); setTimeout(()=>el.classList.remove('hot-active'),300); }
      closeCurrentPopup();
    };
    popup.appendChild(btn);
  });
  // allow clicking outside to close
  document.body.appendChild(popup);
  currentPopup = popup;
  // adjust if overflow
  const rect = popup.getBoundingClientRect();
  if(rect.right > window.innerWidth - 8) popup.style.left = (x - rect.width - 8) + 'px';
  if(rect.bottom > window.innerHeight - 8) popup.style.top = (y - rect.height - 8) + 'px';
}
function closeCurrentPopup(){ if(currentPopup){ currentPopup.remove(); currentPopup = null; } }
document.addEventListener('click', ()=> closeCurrentPopup());

/* builder controls */
document.getElementById('speak-btn').addEventListener('click', ()=>{
  if(currentSentence.length===0){ speakLocalized({'zh-TW':'å°šæœªæœ‰å¥å­','en-US':'No sentence yet'}); return;}
  // join Chinese without spaces; for non-zh use spaces
  const lang = currentLang || 'zh-TW';
  const txt = (lang==='zh-TW')? currentSentence.map(c=>c.text||c).join('') : currentSentence.map(c=>c.text||c).join(' ');
  speakLocalized(txt, lang);
});
document.getElementById('undo-btn').addEventListener('click', ()=> { currentSentence.pop(); refreshSentenceUI(); });
document.getElementById('clear-btn').addEventListener('click', ()=> { if(confirm('ç¢ºèªè¦æ¸…é™¤å¥å­å—ï¼Ÿ')){ currentSentence=[]; refreshSentenceUI(); } });

/* modal for adding builder words (simple inline) */
function showAddModal(){ const zh = prompt('æ–°å¢ä¸­æ–‡è©å½™ï¼ˆä¾‹å¦‚ï¼šæˆ‘è¦ï¼‰'); if(zh){ BUILDER['ä¸»è©'].push({id:'custom_'+Date.now(), zh}); renderBuilder(); } }

/* language select change */
langSelect.addEventListener('change', ()=> { currentLang = langSelect.value; localStorage.setItem('aac_lang', currentLang); });

/* helper speak wrapper */
function speakLocalized(textOrObj, langOverride){
  // Use the earlier defined function but ensure voices loaded
  if(!window.speechSynthesis.getVoices().length) { setTimeout(()=>speakLocalized(textOrObj,langOverride),120); return; }
  // pick language-specific string
  let lang = langOverride || currentLang || 'zh-TW';
  let text;
  if(typeof textOrObj === 'string') text = textOrObj;
  else text = textOrObj[lang] || textOrObj[lang.split('-')[0]] || textOrObj['zh-TW'] || Object.values(textOrObj)[0];
  if(!text) return;
  if(navigator.vibrate) navigator.vibrate(40);
  const utt = new SpeechSynthesisUtterance(text);
  utt.lang = lang;
  const v = pickVoiceForLang(lang);
  if(v) utt.voice = v;
  utt.rate = (lang==='zh-TW')?0.9:0.85;
  try{ window.speechSynthesis.cancel(); }catch(e){}
  window.speechSynthesis.speak(utt);
}

/* reuse pickVoiceForLang (slightly simplified) */
function pickVoiceForLang(lang){
  const vs = window.speechSynthesis.getVoices() || voices;
  if(!vs.length) return null;
  if(lang==='zh-TW'){
    let c = vs.find(x=>x.lang==='zh-TW' && (/Google|Taiwan|å°ç£|zh_TW|Yun/i.test(x.name)));
    if(c) return c;
    c = vs.find(x=>x.lang.startsWith('zh'));
    if(c) return c;
  } else {
    let c = vs.find(x=>x.lang===lang || x.lang.startsWith(lang.split('-')[0]));
    if(c) return c;
  }
  return vs[0];
}

/* attach hotspots and initial render */
function init(){
  renderQuick(); renderEmotions(); renderBuilder(); refreshSentenceUI(); renderStatusTags(); attachHotspots();
  // ensure currentLang stored
  currentLang = localStorage.getItem('aac_lang') || currentLang;
  document.getElementById('lang-select').value = currentLang;
}
init();

/* ensure voices loaded later as well */
window.addEventListener('load', ()=> { setTimeout(()=>{ loadVoices(); },200); });

/* keyboard accessibility for bottom nav */
[navQuick,navEmotion,navBuilder,navSettings].forEach(n=>{ n.setAttribute('tabindex',0); n.addEventListener('keydown',(e)=>{ if(e.key==='Enter' || e.key===' ') n.click(); }); });

</script>
</body>
</html>
